<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BAMBAM — Daily WOD</title>

<!-- PWA / iOS: opens like an app -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Daily WOD">
<meta name="theme-color" content="#0f1115">
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='128' height='128'%3E%3Crect width='100%25' height='100%25' fill='%230f1115'/%3E%3Ctext x='50%25' y='58%25' text-anchor='middle' fill='%23e8eaf0' font-size='64' font-family='Arial'%3E%F0%9F%8F%8B%EF%B8%8F%3C/text%3E%3C/svg%3E">
<link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAYAAABb0P4JAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABcUlEQVR42u3RAQ0AAAwCoNm/9C1gkQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADwqgkAAQh7b7cAAAAASUVORK5CYII=" />

<style>
  :root{
    --bg:#0f1115; --card:#151922; --ink:#e8eaf0; --muted:#aab0c0; --accent:#61dafb; --border:#2a3345;
  }
  *{box-sizing:border-box}
  body{margin:0;padding:24px;background:var(--bg);color:var(--ink);
       font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  h1,h2,h3{margin:0 0 8px;line-height:1.15}
  h1{font-size:28px} h2{font-size:20px;color:var(--muted);font-weight:600} h3{font-size:16px;color:var(--muted);font-weight:600}
  .wrap{max-width:900px;margin:0 auto;display:grid;gap:16px}
  .card{background:var(--card);border:1px solid #222937;border-radius:12px;padding:16px;box-shadow:0 4px 18px rgba(0,0,0,.25)}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:center}
  button{background:#111723;color:var(--ink);border:1px solid var(--border);border-radius:8px;padding:10px 12px;cursor:pointer;font:inherit}
  button:hover{border-color:var(--accent)}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid var(--border);background:#0d1320;color:var(--muted);font-size:12px;margin-right:6px}
  .meta{color:var(--muted);font-size:14px}
  ul{margin:8px 0 0 20px} li{margin:4px 0}
  .notice{background:#1a2030;border-left:4px solid var(--accent);padding:10px 12px;border-radius:8px}
  .center{text-align:center}
  .date-chip{cursor:pointer;display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#0d1320;user-select:none}
  .date-chip:hover{border-color:var(--accent)}
  #dateWrap{display:flex;justify-content:center;position:relative}
  .cal{position:absolute;top:calc(100% + 8px);left:50%;transform:translateX(-50%);
       width:320px;background:var(--card);border:1px solid var(--border);border-radius:12px;
       box-shadow:0 12px 36px rgba(0,0,0,.45);padding:12px;display:none;z-index:1000}
  .cal.show{display:block}
  .cal header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .cal .hdr-btn{background:#111723;border:1px solid var(--border);border-radius:8px;padding:6px 10px;font-size:13px;color:var(--ink);cursor:pointer}
  .cal .hdr-btn:hover{border-color:var(--accent)}
  .cal .label{font-weight:700;color:#e8eaf0}
  .cal .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:8px}
  .cal .dow{font-size:12px;color:var(--muted);text-align:center}
  .cal .day{font-size:13px;text-align:center;padding:6px 0;border-radius:8px;border:1px solid transparent;cursor:pointer}
  .cal .day:hover{border-color:var(--accent);background:#0d1320}
  .cal .muted{opacity:.4}
  .cal .today{outline:1px dashed var(--accent);outline-offset:2px}
  .cal .selected{background:#0d1320;border-color:var(--accent)}
  @media print{ .controls, .footer, .cal {display:none} body{background:white;color:#111} .card{box-shadow:none;border-color:#ddd}}
  footer{margin-top:24px;text-align:center;color:#9aa3b2;font-size:12px}
  footer a{color:#9aa3b2;text-decoration:none}
  footer a:hover{color:#e8eaf0}
</style>
</head>

<body>
<div class="wrap">
  <!-- HEADER + CONTROLS -->
  <div class="card">
    <h1 class="center">Daily WOD</h1>
    <div id="dateWrap">
      <div id="todayStr" class="meta center date-chip" title="Pick a date"></div>
      <div id="cal" class="cal" aria-hidden="true"></div>
    </div>
    <div class="row controls" style="margin-top:8px;">
      <button id="prevBtn">◀ Prev</button>
      <button id="todayBtn">Today</button>
      <button id="nextBtn">Next ▶</button>
    </div>
  </div>

  <!-- WOD CARD -->
  <div class="card">
    <div class="row" style="justify-content:space-between">
      <h2 id="wodTitle">Workout</h2>
      <div>
        <span class="pill" id="typePill"></span>
        <span class="pill" id="timePill"></span>
        <span class="pill" id="targetPill"></span>
      </div>
    </div>
    <div id="wodBody"></div>
    <div class="meta" id="wodNotes" style="margin-top:8px;"></div>
    <div id="wodTribute" class="notice" style="display:none;margin-top:8px;"></div>
  </div>

  <!-- WARMUP / COOLDOWN -->
  <div class="card">
    <h3>Warm-Up</h3>
    <div id="warmup" class="notice"></div>
  </div>

  <div class="card">
    <h3>Cooldown</h3>
    <div id="cooldown" class="notice"></div>
  </div>

  <footer>© 2025 <a href="https://bambambuilt.com" target="_blank" rel="noopener">bambambuilt.com</a>. All Rights Reserved.</footer>
</div>

<!-- Load ALL known WODs (bank + tributes + optional fixed-date map) -->
<script src="wods.js"></script>

<script>
/* ========= UTIL ========= */
const rng = (seed=>function(){let t=seed+=0x6D2B79F5;t=Math.imul(t^(t>>>15),t|1);t^=t+Math.imul(t^(t>>>7),t|61);return((t^(t>>>14))>>>0)/4294967296})(1337);
const choice=(a)=>a[Math.floor(rng()*a.length)];
const clamp=(n,min,max)=>Math.max(min,Math.min(max,n));
const daysInYear=(y)=>((y%4===0&&y%100!==0)||(y%400===0))?366:365;
const doy=(d)=>{const s=new Date(d.getFullYear(),0,1);return Math.floor((d-s)/(24*3600*1000))+1;}
const fromDoy=(y,dy)=>{const d=new Date(y,0,1);d.setDate(dy);return d;}
const fmtDate=(d)=>d.toLocaleDateString(undefined,{weekday:'long',year:'numeric',month:'long',day:'numeric'});

/* ========= BANK / TRIBUTES from wods.js ========= */
const BANK = (window.WOD_BANK||[]);
const TRIBUTES = (window.WOD_TRIBUTES||{});
const FIXED = (window.WOD_DATE_MAP||{});   // optional "MM-DD": "Title"

/* ========= TAGS to drive warm-up/cooldown ========= */
function tagsFor(bodyArr){
  const t = bodyArr.join(" ");
  return {
    run:/\bRun\b|\bShuttle\b|km Run/.test(t),
    row:/\bRow\b|\bCal Row\b|km Row/.test(t),
    rope:/Double-unders|Single-unders|jump rope/i.test(t),
    wb:/Wall Balls?/.test(t),
    pull:/(Pull-ups|C2B|Chest-to-Bar|Bar Muscle-ups|L-Pull-ups|BMU)/i.test(t),
    ttb:/Toes-to-Bar|Knee Raises/i.test(t),
    hspu:/Handstand Push-ups|Wall Walks/i.test(t),
    db:/DB /i.test(t),
    kb:/KB /i.test(t),
    box:/Box (Jumps|Step-ups|Jump-Overs)/i.test(t)
  };
}

/* ========= Smart warm-up & cooldown ========= */
function pickWarmup(T){
  if(T.run||T.rope) return [
    "6–8 min build: jog or easy row.",
    "2 rounds (quality): 10 calf raises, 10 leg swings/leg, 10 glute bridges, 20s ankle rocks.",
    T.rope?"30–45s easy single-unders":""
  ].filter(Boolean).join("<br>");
  if(T.row) return [
    "6–8 min easy row — add 10s power strokes every min.",
    "2 rounds: 8 banded lat stretch (each), 10 hip hinge (PVC), 10 hollow/arch beat swings."
  ].join("<br>");
  if(T.wb||T.box) return [
    "8 min: bike/jog/row easy.",
    "2 rounds: 10 wall balls (light), 8 goblet squats, 8 hip openers/leg, 10 shoulder pass-throughs."
  ].join("<br>");
  if(T.pull||T.ttb) return [
    "6 min easy cardio.",
    "2 rounds: 20s active hang, 5 kip swings + 5 hollow rocks, 8 scap pull-ups, 8 ring rows or banded PUs."
  ].join("<br>");
  if(T.hspu) return [
    "6 min easy cardio.",
    "2 rounds: 8 pike push-ups (elev), 10 shoulder taps, 10 banded press-downs, 10 wrist circles."
  ].join("<br>");
  if(T.db||T.kb) return [
    "6 min easy cardio.",
    "2 rounds: 10 KB swings (light), 8 goblet squats, 8 bootstrappers, 10 band pull-aparts."
  ].join("<br>");
  return "5–8 min easy cardio, then 2 rounds: 10 air squats, 8 push-ups, 15s hang, 8 lunges/leg.";
}
function pickCooldown(T){
  const base = ["3–5 min easy walk/row to drop HR."];
  if(T.run||T.rope) base.push("Calf stretch 2× :30/side, couch stretch 2× :45/side.");
  if(T.row||T.pull||T.ttb) base.push("Banded lat stretch 2× :30/side, 1–2 mins easy hang.");
  if(T.wb||T.db||T.kb||T.box) base.push("Hip flexor + glute figure-4 2× :30/side.");
  return base.join("<br>");
}

/* ========= Generator pools (kept simple) ========= */
const MONO = ["Run 400m","Run 600m","Run 800m","Row 500m","Row 750m","Row 1000m","150 Single-unders","100 Double-unders"];
const GYM  = ["Pull-ups","Chest-to-Bar Pull-ups","Bar Muscle-ups","Toes-to-Bar","Push-ups","Sit-ups","Air Squats","Pistols (alt)","Handstand Push-ups","Burpees","Wall Walks","Hanging Knee Raises"];
const DBB  = ["16 DB Thrusters — 2×50 lb","14 DB Push Press — 2×50 lb","16 DB Front Squats — 2×50 lb","14 DB Power Cleans — 2×50 lb","20 DB Deadlifts — 2×50 lb","16 Alt DB Snatches — 1×50 lb"];
const KBB  = ["25 KB Swings — 53 lb","20 KB Goblet Squats — 53 lb","14 KB Clean & Press (alt) — 53 lb","20 KB Swings — 35 lb"];
const BOXM = ['20 Box Jumps — 24"','14 Burpee Box Jump-Overs — 24"'];
const WB   = ["25 Wall Balls","30 Wall Balls","40 Wall Balls"];

function amrap(mins){ const A=[choice(MONO.concat(WB)), choice(DBB.concat(KBB).concat(BOXM)), choice(GYM)];
  return {title:`AMRAP ${mins}`, type:"AMRAP", time:String(mins),
    body:[`As many rounds as possible in ${mins} minutes:`].concat(A.map(x=>"• "+x))
  };
}
function emom(mins){ return {title:`EMOM ${mins} — Rotate 3`, type:"EMOM", time:String(mins),
  body:[`Every minute for ${mins} min, rotate:`,"1) "+choice(DBB.concat(KBB).concat(WB)),"2) "+choice(GYM),"3) "+choice(MONO),"Finish each minute in ~40–45s."]}; }
function chipper(){ const bag=[choice(WB),choice(MONO),choice(DBB.concat(KBB)),choice(GYM),choice(BOXM)];
  while(bag.length<10){ const c=choice(WB.concat(MONO,DBB,KBB,GYM,BOXM)); if(!bag.includes(c)) bag.push(c); }
  return {title:"Chipper — For Time (Long)", type:"For Time", time:"30–60", body:["Complete for time:"].concat(bag.map(x=>"• "+x))}; }

/* ========= Pin logic (guarantee every known WOD appears at least once) ========= */
function memorialDayDate(y){ // last Monday of May (local)
  const d=new Date(y,4,31); // May 31
  const offset=(d.getDay()+6)%7; // 0=Mon
  d.setDate(31-offset);
  return d;
}
function mmdd(d){const m=String(d.getMonth()+1).padStart(2,'0');const dd=String(d.getDate()).padStart(2,'0');return `${m}-${dd}`;}

function buildScheduleMap(year, days){
  const map = new Map();

  // Fixed-date overrides (from wods.js, if any)
  Object.entries(FIXED).forEach(([k,title])=>{
    const [m,day]=k.split("-").map(Number);
    const dt = new Date(year,m-1,day);
    const doyKey = doy(dt);
    const idx = BANK.findIndex(b=>b.title===title);
    if(idx>-1) map.set(doyKey, idx);
  });

  // Pinned commemorations
  const pins = [
    {date: memorialDayDate(year), title: "Murph"},
    {date: new Date(year,8,11),  title: "Glen (Home)"},                // 09/11
    {date: new Date(year,10,11), title: 'Chad 1000X (24")'},           // 11/11
    {date: new Date(year,11,25), title: "12 Days of Christmas (Home)"},// 12/25
    {date: new Date(year,6,4),   title: "Kalsu (DB Thruster)"}         // 07/04
  ];
  pins.forEach(p=>{
    const idx = BANK.findIndex(b=>b.title===p.title);
    if(idx>-1) map.set(doy(p.date), idx);
  });

  // Evenly distribute all BANK items at least once through the year
  const step = Math.floor(days / Math.max(1,BANK.length)); // ~3–4 days
  let dayCursor = 1;
  for(let i=0;i<BANK.length;i++){
    // find next empty day
    while(map.has(dayCursor) && dayCursor<=days) dayCursor++;
    if(dayCursor>days) break;
    map.set(dayCursor, i); // i-th WOD
    dayCursor += Math.max(1, step);
  }
  return map;
}

/* ========= Build the year ========= */
function buildYear(year){
  const days = daysInYear(year);
  const scheduleMap = buildScheduleMap(year, days);
  const out = new Array(days);

  for(let d=1; d<=days; d++){
    if(scheduleMap.has(d)){
      const b = BANK[scheduleMap.get(d)];
      out[d-1] = {title:b.title,type:b.type,time:b.time,body:b.body.slice(),notes:b.notes||"",named:true};
    }else{
      const dow = (d-1)%7;
      const w = (dow===6)?chipper(): (dow%2===0?amrap(choice([20,24,30,40])):emom(choice([24,30,36,40])));
      out[d-1] = w;
    }
  }
  return out;
}

/* ========= UI ========= */
const elTitle=document.getElementById("wodTitle");
const elBody=document.getElementById("wodBody");
const elNotes=document.getElementById("wodNotes");
const elType=document.getElementById("typePill");
const elTime=document.getElementById("timePill");
const elTarget=document.getElementById("targetPill");
const elTribute=document.getElementById("wodTribute");
const dateChip=document.getElementById("todayStr");
const cal=document.getElementById("cal");

let currentDate=new Date();
let currentYear=currentDate.getFullYear();
let YEAR = buildYear(currentYear);

function paceHint(w){return (w.type==="For Time")?"Target: 30–60 min":`Target: ${w.time} min`; }
function isCommemorative(title){return TRIBUTES[title]!==undefined;}

function renderByDate(dt){
  if(dt.getFullYear()!==currentYear){ currentYear=dt.getFullYear(); YEAR=buildYear(currentYear); }
  const idx = clamp(doy(dt),1,daysInYear(currentYear)) - 1;
  const w = YEAR[idx];

  dateChip.textContent = fmtDate(dt);
  elTitle.textContent = w.named? `${w.title} (Benchmark)` : w.title;
  elType.textContent = w.type;
  elTime.textContent = w.time;
  elTarget.textContent = paceHint(w);
  elBody.innerHTML = "<ul>"+w.body.map(l=>`<li>${l}</li>`).join("")+"</ul>";
  elNotes.textContent = w.notes || "";

  if(isCommemorative(w.title)){ elTribute.style.display="block"; elTribute.textContent=TRIBUTES[w.title]; }
  else { elTribute.style.display="none"; elTribute.textContent=""; }

  // smart warm-up & cooldown for this WOD
  const T = tagsFor(w.body);
  document.getElementById("warmup").innerHTML = pickWarmup(T);
  document.getElementById("cooldown").innerHTML = pickCooldown(T);

  currentDate = dt;
  if(cal.classList.contains('show')) buildCalendar(currentDate.getFullYear(), currentDate.getMonth());
}

/* ========= Calendar ========= */
const MONTHS=["January","February","March","April","May","June","July","August","September","October","November","December"];
const DOW=["S","M","T","W","T","F","S"];

function buildCalendar(year, month){
  cal.innerHTML = ""; // reset
  const first=new Date(year,month,1);
  const firstDow=first.getDay();
  const daysThis=new Date(year,month+1,0).getDate();
  const daysPrev=new Date(year,month,0).getDate();

  let html = `
    <header>
      <button class="hdr-btn" id="calPrev">&larr;</button>
      <div class="label">${MONTHS[month]} ${year}</div>
      <button class="hdr-btn" id="calNext">&rarr;</button>
    </header>
    <div class="grid">`;
  for(const d of DOW) html += `<div class="dow">${d}</div>`;
  for(let i=0;i<firstDow;i++){ html += `<div class="day muted">${daysPrev-firstDow+1+i}</div>`; }
  const today=new Date();
  for(let d=1; d<=daysThis; d++){
    const thisDate=new Date(year,month,d);
    const cls = ["day"];
    if(today.toDateString()===thisDate.toDateString()) cls.push("today");
    if(currentDate.toDateString()===thisDate.toDateString()) cls.push("selected");
    html += `<div class="${cls.join(" ")}" data-day="${d}">${d}</div>`;
  }
  const used=firstDow+daysThis; const need=(7-(used%7))%7;
  for(let i=1;i<=need;i++) html+=`<div class="day muted">${i}</div>`;
  html += `</div>`;
  cal.innerHTML = html;

  document.getElementById('calPrev').onclick=()=>{ let m=month-1,y=year; if(m<0){m=11;y--;} buildCalendar(y,m); };
  document.getElementById('calNext').onclick=()=>{ let m=month+1,y=year; if(m>11){m=0;y++;} buildCalendar(y,m); };
  cal.querySelectorAll('.day[data-day]').forEach(el=>{
    el.onclick=()=>{ renderByDate(new Date(year, month, Number(el.getAttribute('data-day')))); closeCalendar(); };
  });
}
function openCalendar(){ buildCalendar(currentDate.getFullYear(), currentDate.getMonth()); cal.classList.add('show'); setTimeout(()=>document.addEventListener('click', outsideClose)); }
function closeCalendar(){ cal.classList.remove('show'); document.removeEventListener('click', outsideClose); }
function outsideClose(e){ if(!cal.contains(e.target) && e.target!==dateChip){ closeCalendar(); } }

/* ========= Init ========= */
function init(){
  renderByDate(currentDate);
  document.getElementById("prevBtn").onclick=()=>{ const d=new Date(currentDate); d.setDate(d.getDate()-1); renderByDate(d); };
  document.getElementById("nextBtn").onclick=()=>{ const d=new Date(currentDate); d.setDate(d.getDate()+1); renderByDate(d); };
  document.getElementById("todayBtn").onclick=()=>{ renderByDate(new Date()); };

  dateChip.addEventListener('click',(e)=>{ e.stopPropagation(); cal.classList.contains('show')?closeCalendar():openCalendar(); });
  document.addEventListener('keydown',(e)=>{ if(e.key==='Escape' && cal.classList.contains('show')) closeCalendar(); });

  // PWA service worker (cache-busted)
  const manifest = {name:"BAMBAM — Daily WOD",short_name:"Daily WOD",start_url:"./",display:"standalone",background_color:"#0f1115",theme_color:"#0f1115",
    icons:[{src:document.querySelector('link[rel="apple-touch-icon"]').href,sizes:"192x192",type:"image/png"}]};
  const manBlob = new Blob([JSON.stringify(manifest)], {type:"application/manifest+json"});
  const manLink = document.createElement('link'); manLink.rel='manifest'; manLink.href=URL.createObjectURL(manBlob); document.head.appendChild(manLink);

  if('serviceWorker' in navigator){
    const sw = `
      const CACHE='bb-wod-v4';
      self.addEventListener('install',e=>{e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./','./wods.js'])));self.skipWaiting();});
      self.addEventListener('activate',e=>{self.clients.claim();});
      self.addEventListener('fetch',e=>{
        if(e.request.mode==='navigate'){ e.respondWith(fetch(e.request).catch(()=>caches.match('./'))); return; }
        e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)));
      });
    `;
    navigator.serviceWorker.register(URL.createObjectURL(new Blob([sw],{type:'text/javascript'})), {scope:'./'});
  }
}
document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>